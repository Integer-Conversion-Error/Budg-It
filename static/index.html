<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budgeting Assistant</title>
    <!-- Include Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- Include Chart.js from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-top: 0;
            text-align: center;
            font-weight: 700;
            font-size: 1.8rem;
        }

        .chat-log {
            height: 450px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #fafafa;
        }

        .chat-log p {
            margin: 6px 0;
            line-height: 1.4em;
        }

        #userInput,
        #receiptInput {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 8px;
        }

        #userInput {
            width: calc(100% - 114px);
            margin-bottom: 10px;
        }

        button {
            padding: 10px 18px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        section#current-budget h2,
        h2 {
            margin-top: 30px;
            font-size: 1.2rem;
            border-bottom: 1px solid #ececec;
            padding-bottom: 4px;
        }

        #budget-value {
            font-size: 1.05rem;
            font-weight: 400;
            margin: 8px 0;
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
        }

        table th,
        table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        table th {
            background-color: #f7f7f7;
            font-weight: 600;
        }

        table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        /* Pie chart section */
        #budget-chart {
            margin-top: 30px;
            text-align: center;
        }

        #budget-chart canvas {
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Budgeting Assistant</h1>

        <div class="chat-log" id="chatLog">
            <!-- Chat logs will be dynamically added here -->
        </div>

        <div>
            <input type="text" id="userInput" placeholder="Type your input here..." />
            <button onclick="sendInput()">Send</button>
        </div>

        <div style="margin-top: 10px;">
            <input type="file" id="receiptInput" accept="image/*" />
            <button onclick="uploadReceipt()">Upload Receipt</button>
        </div>

        <section id="current-budget">
            <h2>Current Budget</h2>
            <p id="budget-value">No Budget Defined</p>
        </section>

        <h2>Budget Items</h2>
        <table id="budgetTable">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Importance Rank</th>
                    <th>Recurrence</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- Budget items will be dynamically added here -->
            </tbody>
        </table>

        <!-- Pie Chart Section -->
        <section id="budget-chart">
            <h2>Budget Distribution</h2>
            <canvas id="pieChart"></canvas>
        </section>
    </div>

    <script>
        let currentState = {
            Budget: {
                budget_limit: null,
                items: [],
                warnings: [],
                conversations: []
            },
            conversation: ""
        };

        const apiUrl = "http://localhost:8000/chat";
        const receiptUrl = "http://localhost:8000/receipt";


        // Updates the chat log with conversation messages.
        function updateChatLog(conversations) {
            const chatLog = document.getElementById("chatLog");
            chatLog.innerHTML = ""; // Clear previous log

            conversations.forEach(chat => {
                const userMessage = document.createElement("p");

                // If the user message ends with the specified phrase, replace with 'Sent Image'.
                const displayText = chat.user_message.endsWith("Please add the above receipt items as budget items.")
                    ? "Sent Image"
                    : chat.user_message;

                userMessage.textContent = `User: ${displayText}`;

                const aiResponse = document.createElement("p");
                aiResponse.textContent = `AI: ${chat.ai_response}`;

                chatLog.appendChild(userMessage);
                chatLog.appendChild(aiResponse);
            });

            chatLog.scrollTop = chatLog.scrollHeight; // Scroll to the bottom
        }
        async function uploadReceipt() {
            const fileInput = document.getElementById('receiptInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("Please select an image file to upload.");
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('receipt', file);
            // Adding a command helps the API route this request appropriately.
            formData.append('command', 'uploadReceipt');
            formData.append('current_state', JSON.stringify(currentState));

            try {
                const response = await fetch(receiptUrl, {
                    method: 'POST',
                    body: formData
                    // No need to set Content-Type header; the browser will do it automatically.
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.statusText}`);
                }

                const data = await response.json();
                // Assume the API now processes the receipt image, extracts items,
                // and returns an updated state with new budget items.
                currentState = data;
                updateChatLog(data.Budget.conversations);
                updateBudgetTable(data.Budget.items);
                updateBudgetItem();
                updateBudgetChart();
                alert("Receipt processed successfully!");
            } catch (error) {
                console.error("Error uploading receipt:", error);
                alert("Failed to process receipt.");
            }
        }



        // Updates the budget table with the latest budget items.
        function updateBudgetTable(items) {
            const tableBody = document.getElementById("budgetTable").querySelector("tbody");
            tableBody.innerHTML = ""; // Clear previous table data
            items.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
          <td>${item.item_name}</td>
          <td>${item.amount}</td>
          <td>${item.category}</td>
          <td>${item.importance_rank}</td>
          <td>${item.recurrence_schedule || "N/A"}</td>
          <td>${item.due_date || "N/A"}</td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Updates the budget limit display.
        function updateBudgetDisplay(budget) {
            const budgetElement = document.getElementById('budget-value');
            if (budget !== null && budget !== undefined) {
                budgetElement.textContent = `$${parseFloat(budget).toFixed(2)}`;
            } else {
                budgetElement.textContent = "No Budget Defined";
            }
        }

        // Mimics updateBudgetTable, but for the budget limit.
        function updateBudgetItem() {
            updateBudgetDisplay(currentState.Budget.budget_limit);
        }

        // Create or update the pie chart that visualizes the budget distribution.
        function updateBudgetChart() {
            const items = currentState.Budget.items;
            const budgetLimit = parseFloat(currentState.Budget.budget_limit) || 0;
            let labels = [];
            let dataValues = [];

            // Sum the cost of budget items and prepare labels/data.
            const totalItemsCost = items.reduce((total, item) => {
                const amount = parseFloat(item.amount) || 0;
                labels.push(item.item_name);
                dataValues.push(amount);
                return total + amount;
            }, 0);

            // Calculate surplus and add it if available.
            const surplus = budgetLimit - totalItemsCost;
            if (surplus > 0) {
                labels.push("Surplus");
                dataValues.push(surplus);
            }

            // Create or update the pie chart using Chart.js.
            if (window.pieChartInstance) {
                // Update existing chart data.
                window.pieChartInstance.data.labels = labels;
                window.pieChartInstance.data.datasets[0].data = dataValues;
                window.pieChartInstance.data.datasets[0].backgroundColor = generateColors(labels.length);
                window.pieChartInstance.update();
            } else {
                // Initialize the chart.
                const ctx = document.getElementById('pieChart').getContext('2d');
                window.pieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: generateColors(labels.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Budget Distribution' }
                        }
                    }
                });
            }
        }

        // Helper function to generate colors for the chart segments.
        function generateColors(numColors) {
            const colors = [
                '#FF6384', // Red-Pink
                '#36A2EB', // Blue
                '#FFCE56', // Yellow
                '#4BC0C0', // Teal
                '#9966FF', // Purple
                '#FF9F40', // Orange
                '#2ECC71', // Green
                '#E74C3C', // Bright Red
                '#8E44AD', // Dark Purple
                '#1ABC9C', // Aqua
                '#D35400', // Dark Orange
                '#C0392B', // Dark Red
                '#3498DB', // Light Blue
                '#F1C40F', // Golden Yellow
                '#27AE60', // Forest Green
                '#9B59B6', // Soft Purple
                '#34495E', // Dark Gray-Blue
                '#16A085', // Deep Teal
                '#F39C12', // Bright Orange
                '#7F8C8D'  // Muted Gray
                ];

            if (numColors <= colors.length) {
                return colors.slice(0, numColors);
            } else {
                let extended = [];
                for (let i = 0; i < numColors; i++) {
                    extended.push(colors[i % colors.length]);
                }
                return extended;
            }
        }

        // Sends user input to the /chat endpoint and updates the state.
        async function sendInput() {
            const userInput = document.getElementById("userInput").value;
            if (!userInput.trim()) {
                alert("Please enter a valid input.");
                return;
            }
            currentState.conversation = userInput;

            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(currentState)
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.statusText}`);
                }

                const data = await response.json();
                // Update the current state with the API response.
                currentState = data;

                // Update the UI components.
                updateChatLog(data.Budget.conversations);
                updateBudgetTable(data.Budget.items);
                updateBudgetItem();
                updateBudgetChart();
                console.debug("New budget_limit:", data.Budget.budget_limit);

                // Clear the input field.
                document.getElementById("userInput").value = "";
            } catch (error) {
                console.error("Error communicating with API:", error);
                alert("Failed to send input to the API.");
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateBudgetItem();
            updateBudgetChart();
        });


    </script>
</body>

</html>